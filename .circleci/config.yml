version: 2

jobs:
  build:
    docker:
      - image: ubuntu:latest
    steps:
      - checkout
      - run:
          name: Install Docker
          command: |
            sudo apt-get update
            sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo \
              "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io
            sudo usermod -aG docker ubuntu
            sudo systemctl enable docker
            sudo systemctl start docker
      - run:
          name: Setup JAVA
          command: |
              sudo apt-get update
              sudo apt-get install -y openjdk-17-jdk
      - run:
          name: Install Maven
          command: |
              sudo apt-get update
              sudo apt-get install -y maven
      - run:
          name: Build Project
          command: mvn clean install -DskipTests
      - run:
          name: Login to Docker Hub
          command: |
              echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run:
          name: Build Docker Image
          command: docker build -t juliandedward/gym-app .

      - run:
          name: Publish Docker Image
          command: docker push juliandedward/gym-app:latest

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build:
          filters:
            branches:
              only: main
